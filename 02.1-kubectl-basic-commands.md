# 2.1. kubectl 基本コマンド

この章では、Kubernetesを操作する上で最も基本的かつ重要なコマンド群を学びます。これらのコマンドは、リソースの状態を確認したり、設定を変更したり、不要になったものを削除したりといった、日々の運用で頻繁に使うCRUD（作成・参照・更新・削除）操作に対応します。

---

### リソースを参照する (Read)

#### リソースを一覧表示する `kubectl get`

`kubectl get`は、指定したリソースの一覧を表示するための最も基本的なコマンドです。Podが動いているか、Serviceは作られているかなど、様々な情報を取得できます。

##### ■ 基本的な使い方

```bash
# Podの一覧を表示する
kubectl get pods

# Deploymentの一覧を表示する
kubectl get deployments

# Serviceの一覧を表示する
kubectl get services

# すべてのリソースを表示する（Namespace内の）
kubectl get all
```

**実行結果の見方 (podsの場合)**

```
NAME                                   READY   STATUS    RESTARTS   AGE
my-nginx-deployment-66b6c48dd5-abcde   1/1     Running   0          2m10s
my-nginx-deployment-66b6c48dd5-fghij   1/1     Running   0          2m10s
```

*   **NAME**: Podの名前です。Deploymentによって作られたPodは、Deployment名の後ろにランダムな文字列が付きます。
*   **READY**: `1/1`のように表示され、「Pod内に定義されたコンテナ数 / 起動準備が完了したコンテナ数」を意味します。ここが`1/1`なら正常です。
*   **STATUS**: Podの現在の状態です。`Running`は正常に動作中であることを示します。他に`Pending`（起動準備中）、`Completed`（正常終了）、`Error`（異常終了）などがあります。
*   **RESTARTS**: Podが再起動した回数です。この回数が多い場合、コンテナ内で何らかの問題が発生している可能性があります。
*   **AGE**: Podが作成されてからの経過時間です。

##### ■ オプションでもっと詳しく見る

`kubectl get`には、表示する情報をカスタマイズするための便利なオプションがあります。

###### **-o wide: より詳細な情報を表示する**

`-o wide` (`--output wide`の略) を付けると、標準の表示に加えて、Podがどのワーカーノードで動いているか(`NODE`)や、Podに割り当てられたIPアドレス(`IP`)などを確認できます。

```bash
kubectl get pods -o wide
```

**実行結果**

```
NAME                                   READY   STATUS    RESTARTS   AGE     IP           NODE
my-nginx-deployment-66b6c48dd5-abcde   1/1     Running   0          5m30s   10.244.1.2   kind-worker
my-nginx-deployment-66b6c48dd5-fghij   1/1     Running   0          5m30s   10.244.2.3   kind-worker2
```

👉 **使いどころ**:
複数のPodが、意図した通りに異なるワーカーノードに分散して配置されているか確認したい場合や、PodのIPアドレスを直接知りたい場合などに非常に役立ちます。

###### **-o yaml: マニフェスト形式で全情報を表示する**

`-o yaml` (`--output yaml`の略) を付けると、そのリソースの**すべての設定情報**を、私たちが普段書いているマニフェストと同じYAML形式で表示します。

```bash
# 特定のPodの情報をYAML形式で表示
kubectl get pod <Podの名前> -o yaml
```

**実行結果（一部抜粋）**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-nginx-deployment-66b6c48dd5-abcde
  namespace: default
  labels:
    app: my-nginx
    pod-template-hash: 66b6c48dd5
  ...
spec:
  containers:
  - image: nginx:latest
    name: nginx-container
    ports:
    - containerPort: 80
      protocol: TCP
  ...
status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: "2024-01-01T12:00:00Z"
    status: "True"
    type: Initialized
  ...
  containerStatuses:
  - containerID: containerd://...
    image: docker.io/library/nginx:latest
    ready: true
    restartCount: 0
    started: true
  ...
  hostIP: 172.18.0.3
  podIP: 10.244.1.2
  ...
```

この中には、私たちがマニフェストに書いた設定(`spec`)だけでなく、Kubernetesが自動で追加した情報（ラベルやIPアドレスなど）や、現在のリソースの状態(`status`)も含まれています。

👉 **使いどころ**:
*   「適用したはずのマニフェストの設定が、正しく反映されているか」を正確に確認したい場合。
*   リソースがどのような状態で動いているのか、詳細な生データを確認したい場合。
*   既存のリソースを元に、新しいマニフェストを作成したい場合（この出力をコピーして編集するなど）。

###### **--v: kubectlコマンド自体のログレベルを変更する**

`--v`オプションは、`kubectl`コマンドがAPIサーバと通信する際の、より詳細なログを出力させたいときに使います。数字が大きいほど、より詳細な情報が表示されます（通常は6〜8がよく使われます）。

```bash
# Podを取得する際の通信ログを詳細に表示する
kubectl get pods --v=8
```

**実行結果（一部抜粋）**

```
I0101 12:05:00.123456   12345 loader.go:372] Config loaded from file: /home/user/.kube/config
I0101 12:05:00.234567   12345 round_trippers.go:445] GET https://<APIサーバのアドレス>/api/v1/namespaces/default/pods 200 OK in 10 milliseconds
...
```

このように、どの設定ファイルを読み込み、どのAPIエンドポイントにリクエストを送り、どのような結果が返ってきたか、といった内部的な動作が詳細に表示されます。

👉 **使いどころ**:
*   `kubectl`コマンド自体がなぜかうまく動かない、エラーになる、といった場合に、その原因を調査するためのデバッグ情報として使います。
*   普段の運用で使うことは稀ですが、「`kubectl`の裏側ではAPIサーバとこんな通信が行われているんだな」という学習目的で見てみるのも面白いでしょう。

##### ■ 特定のリソースだけを指定して見る

リソースがたくさんある中で、特定の1つだけを見たい場合は、リソース名の後ろにその名前を指定します。

```bash
# "my-nginx-deployment-66b6c48dd5-abcde" という名前のPodだけを表示
kubectl get pod my-nginx-deployment-66b6c48dd5-abcde

# "my-nginx-service" という名前のServiceだけを表示
kubectl get service my-nginx-service
```

これにより、大量の情報の中から目的のリソースだけを素早く見つけることができます。

---

#### リソースの詳細情報を表示する `kubectl describe`

`kubectl get`がリソースの一覧を**表形式**でシンプルに表示するのに対し、`kubectl describe`は特定のリソースに関する**詳細な情報や関連イベント**を、人間が読みやすい形式で表示してくれます。

特に、Podがうまく起動しない（`Pending`や`Error`状態になる）など、問題が発生したときの原因調査に絶大な効果を発揮します。

##### ■ 基本的な使い方

```bash
# 特定のPodの詳細情報を表示
kubectl describe pod <Podの名前>

# 特定のDeploymentの詳細情報を表示
kubectl describe deployment <Deploymentの名前>
```
特に、出力の末尾にある`Events`セクションには、Podの作成から起動までの過程や、発生したエラーなどが記録されており、トラブルシューティングの重要な手がかりとなります。

##### ■ 実行結果の見方とポイント

`kubectl describe pod <Pod名>` の実行結果は、いくつかのセクションに分かれています。特に重要なのが一番下の `Events` セクションです。

```
Name:         my-nginx-deployment-66b6c48dd5-abcde
Namespace:    default
Priority:     0
Node:         kind-worker/172.18.0.3
Start Time:   Tue, 01 Jan 2024 12:00:00 +0900
Labels:       app=my-nginx
              pod-template-hash=66b6c48dd5
Annotations:  <none>
Status:       Running
IP:           10.244.1.2
IPs:
  IP:  10.244.1.2
Containers:
  nginx-container:
    Container ID:   containerd://...
    Image:          nginx:latest
    Image ID:       docker.io/library/nginx@sha256:...
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 01 Jan 2024 12:00:05 +0900
    Ready:          True
    Restart Count:  0
    ...
Volumes:
  ...
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
...
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  10m   default-scheduler  Successfully assigned default/my-nginx-deployment-66b6c48dd5-abcde to kind-worker
  Normal  Pulling    10m   kubelet            Pulling image "nginx:latest"
  Normal  Pulled     10m   kubelet            Successfully pulled image "nginx:latest" in 4s
  Normal  Created    10m   kubelet            Created container nginx-container
  Normal  Started    10m   kubelet            Started container nginx-container
```

*   **基本情報**: `Name`, `Namespace`, `Node`など、Podの基本的な情報が表示されます。
*   **Containers**: Pod内で動いているコンテナの詳細情報です。使用しているDockerイメージ、ポート設定、現在の状態(`State`)などがわかります。
*   **Events**: **ここが最も重要です。** このリソースに関連して発生したイベントが時系列で表示されます。
    *   `Scheduled`: Podがどのワーカーノードに割り当てられたか
    *   `Pulling`: コンテナイメージのダウンロードを開始したか
    *   `Pulled`: イメージのダウンロードが成功したか
    *   `Created`: コンテナが作成されたか
    *   `Started`: コンテナが起動したか

👉 **使いどころ**:
PodのSTATUSが`Pending`のまま進まない場合、`Events`セクションを見れば、「イメージのダウンロードに失敗している(`ImagePullBackOff`)」や「配置できるノードが見つからない(`FailedScheduling`)」といった具体的な原因が記録されています。`kubectl get`で異常を見つけたら、まず`kubectl describe`で詳細を確認する、というのがトラブルシューティングの定石です。


---

### リソースを更新する (Update)

#### 稼働中のリソースを編集する `kubectl edit`

`kubectl edit`は、稼働中のリソースのマニフェストを**その場で直接編集**し、変更を適用するためのコマンドです。

`kubectl apply -f <file.yaml>`では「①YAMLファイルを修正 → ②applyコマンド実行」という2ステップが必要ですが、`kubectl edit`を使えば、このプロセスを1ステップで、より素早く行うことができます。

##### ■ 基本的な使い方

`edit`の後ろにリソースの種類と名前を指定します。Deploymentだけでなく、PodやServiceなど、ほとんどのリソースが編集可能です。

```bash
# "my-nginx-deployment" というDeploymentを編集する
kubectl edit deployment my-nginx-deployment

# "my-first-pod" というPodを編集する
kubectl edit pod my-first-pod
```
このコマンドを実行すると、環境変数 `EDITOR` で設定されたテキストエディタが起動し、表示されたマニフェストを編集・保存することで、変更が即座にクラスタに適用されます。

**Deploymentの編集例**
```yaml
# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nginx-deployment
  ...
spec:
  progressDeadlineSeconds: 600
  replicas: 2  # <-- 例えば、この値を 3 に変更する
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: my-nginx
  ...
```

ここで、例えば `replicas` の値を `2` から `3` に変更して保存・終了すると、`kubectl`がその変更を即座にクラスタに適用します。

その後 `kubectl get pods` を実行すれば、Podが3つに増えていることが確認できます。

**注意点：Podの編集について**
`kubectl edit pod <Pod名>`でPodを直接編集することも可能ですが、**変更できるフィールドは限られています**。例えば、Podが使用するコンテナイメージ(`spec.containers[0].image`)など、根本的な定義は後から変更できません。変更しようとして保存しても、APIサーバからエラーが返されます。一般的に、Podの定義を変更したい場合は、そのPodを管理しているDeploymentなどを編集するのが正しいアプローチです。

##### ■ `kubectl edit` vs `kubectl apply`

| | `kubectl edit` | `kubectl apply -f <file.yaml>` |
| :--- | :--- | :--- |
| **手軽さ** | 非常に手軽。コマンド一発で編集・適用できる。 | ファイルの編集とコマンド実行の2段階が必要。 |
| **変更履歴** | **残らない**。誰がいつ何を変更したか追跡が困難。 | **残る**。GitでYAMLファイルを管理すれば変更履歴は明確。 |
| **再現性** | 低い。同じ変更を別のクラスタに適用するのが難しい。 | 高い。同じYAMLファイルを適用すればよい。 |
| **主な用途** | ・一時的なデバッグ（Pod数を増やすなど）<br>・緊急の修正<br>・設定値の意味を学ぶための試行錯誤 | ・本番・開発環境での定常的な運用<br>・CI/CDパイプラインでの自動デプロイ |

`kubectl edit`は非常に便利ですが、**変更が手元やGitのYAMLファイルに反映されない**という大きな欠点があります。これにより、「Gitで管理しているマニフェストと、実際に動いている設定が違う」という状態（**設定ドリフト**）が発生しやすくなります。

👉 **使いどころ**:
原則として、本番環境など、構成管理が重要な環境での恒久的な変更には**使うべきではありません**。
*   開発環境で「このパラメータを変えたらどうなるだろう？」と気軽に試したい場合。
*   本番障害時など、一刻も早く設定を変更する必要がある場合の緊急避難的な手段として。

普段の運用では`git`でYAMLファイルを管理し、`kubectl apply`で変更を適用するフローを徹底し、`kubectl edit`はあくまで一時的なツールとして使い分けるのが賢明です。

---

### リソースを削除する (Delete)

#### リソースを削除する `kubectl delete`

`kubectl delete`は、不要になったリソースをクラスタから削除するためのコマンドです。一度削除したリソースは（基本的には）元に戻せないので、特に本番環境では対象をよく確認してから実行する必要があります。

##### ■ 基本的な使い方

```bash
# "my-first-pod" という名前のPodを削除する
kubectl delete pod my-first-pod

# "my-nginx-service" という名前のServiceを削除する
kubectl delete service my-nginx-service
```

Deploymentを削除すると、そのDeploymentによって管理されていたPodも**すべて一緒に削除される**点に注意してください。

```bash
# Deploymentを削除（管理下のPodもすべて削除される）
kubectl delete deployment my-nginx-deployment
```

##### ■ マニフェストファイルを使って削除する

`kubectl apply -f`でリソースを作成した場合、同じファイルを使って削除することもできます。`-f`オプションは`delete`コマンドでも有効です。

```bash
# nginx-app.yaml に定義されているすべてのリソースを削除する
kubectl delete -f nginx-app.yaml
```

この方法は、複数のリソース（DeploymentとServiceなど）を一度にまとめてクリーンアップしたい場合に非常に便利です。

##### ■ ラベルを使ってまとめて削除する

`-l`オプションでラベルを指定すれば、特定のラベルが付いたリソースをまとめて削除することもできます。

```bash
# "app=my-nginx" というラベルが付いたすべてのPodを削除
kubectl delete pod -l app=my-nginx
```

**警告**: このコマンドは非常に強力で、意図しないリソースまで削除してしまう危険性があります。実行する前に、`kubectl get pods -l app=my-nginx` のように`get`コマンドで対象となるリソースを正確に確認する癖をつけましょう。

##### ■ `--force` オプションについて

リソースが何らかの理由で正常に終了できず、`Terminating`状態のまま止まってしまうことがあります。そのような場合に、`--force`オプションを付けて強制的にリソースを削除することもできますが、これは**最後の手段**です。

```bash
# Podを強制的に削除（非推奨）
kubectl delete pod <Pod名> --force
```

強制削除は、クラスタ内で管理情報に不整合を起こす可能性があり、予期せぬ問題を引き起こすことがあります。まずは`kubectl describe`などでなぜ終了できないのか原因を調査し、どうしても解決しない場合の最終手段としてのみ検討してください。
